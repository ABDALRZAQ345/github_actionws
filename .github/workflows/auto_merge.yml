name: Auto Merge
## not secure test required but it is just for learning
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target branch (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch PR branch
        run: |
          git fetch origin ${{ github.event.pull_request.head.ref }}:${{ github.event.pull_request.head.ref }}

      - name: Configure Git identity
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Check for merge conflicts
        id: conflict_check
        run: |
          git checkout main
          if ! git merge --no-commit --no-ff ${{ github.event.pull_request.head.ref }}; then
            echo "❌ Conflicts detected. Merge aborted."
            git merge --abort
            exit 1
          fi
          echo "✅ No conflicts detected."
          git merge --abort  

      - name: Merge PR branch into main
        if: success()
        run: |
          git merge --no-ff ${{ github.event.pull_request.head.ref }} -m "Auto-merged PR #${{ github.event.pull_request.number }}"
          git push origin main


